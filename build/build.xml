<project name="ESys Framework - Create Archives" default="main" basedir="..">

    <target name="init">
        <input 
            message="Enter version tag:" 
            addproperty="version"/>
        <fail message="version tag required"><condition>
            <equals arg1="${version}" arg2="" trim="true"/>
        </condition></fail>
        <property name="tempdir" value="build/temp" />
        <property name="outputdir" value="build/out" />
        <property name="exportName" value="esys-framework-${version}" />
        <property name="apiDocsName" value="esys-framework-api-${version}" />
    </target>

    <target name="prepdirs" depends="init">
        <delete dir="${outputdir}"/>
        <delete dir="${tempdir}"/>
        <mkdir dir="${outputdir}"/>
    </target>

    <target name="export" depends="prepdirs">
        <mkdir dir="${tempdir}"/>
        <echo message="exporting tag ${version} from svn repo..."/>
        <exec executable="bash" failonerror="true">
            <arg value="-c" />
            <arg value="svn export http://svn.sala.ca/webapp/tags/${version} ${tempdir}/${exportName}; exit $?" />
        </exec>
        <available file="${tempdir}/${exportName}" property="sourceWasExported"/>
        <fail message="failed to export source from svn repo"><condition>
            <isfalse value="${sourceWasExported}"/>
        </condition></fail>
        <delete dir="${tempdir}/${exportName}/build"/>
        <tar destfile="${outputdir}/${exportName}.tgz" basedir="${tempdir}" compression="gzip"/>
        <copy file="${tempdir}/${exportName}/install/CHANGELOG" todir="${outputdir}"/>
    </target>

    <target name="docs" depends="prepdirs">
        <mkdir dir="${tempdir}/${apiDocsName}"/>
        <echo message="building api documentation..."/>
        <exec executable="bash" failonerror="true">
            <arg value="-c" />
            <arg value="phpdoc -q
                --title 'ESys Framework' 
                --output 'HTML:frames:earthli' 
                --parseprivate 'Off' 
                --defaultpackagename 'ESys' 
                -t ${tempdir}/${apiDocsName} 
                -d ${tempdir}/${exportName}/lib/library" />
        </exec>
        <available file="${tempdir}/${apiDocsName}/index.html" property="docsGenerated"/>
        <fail message="failed to generate api docs"><condition>
            <isfalse value="${docsGenerated}"/>
        </condition></fail>
        <delete dir="${tempdir}/${exportName}"/>
        <tar destfile="${outputdir}/${apiDocsName}.tgz" basedir="${tempdir}" compression="gzip"/>
        <delete dir="${tempdir}"/>
    </target>

    <target name="main" depends="export,docs">
    </target>

</project>
